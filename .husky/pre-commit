#!/bin/bash
# .husky/pre-commit

echo "üîç V√©rification pre-commit du monorepo CLSRP..."

# Fonction pour r√©cup√©rer les fichiers staged
get_staged_files() {
    git diff --cached --name-only
}

# Fonction pour v√©rifier si des fichiers de code ont √©t√© modifi√©s
check_source_files_changed() {
    local staged_files=$(get_staged_files)
    echo "$staged_files" | grep -E '\.(ts|tsx|js|jsx|json|jsonc)$' > /dev/null
    return $?
}

# Fonction pour v√©rifier si seulement des fichiers non-critiques ont √©t√© modifi√©s
check_only_non_critical_files() {
    local staged_files=$(get_staged_files)

    local total_files=$(printf '%s\n' "$staged_files" | sed '/^$/d' | wc -l)
    local non_critical=$(printf '%s\n' "$staged_files" | grep -E -c '(^README\.md$|^LICENSE$|^\.gitignore$|^\.husky/|^\.vscode/|^\.github/|.*\.md$|^\.env\.example$)')

    if [ "$total_files" -eq "$non_critical" ] && [ "$total_files" -gt 0 ]; then
        return 0
    fi
    return 1
}

# Retourne la liste des apps existantes parmi web/api/bot
get_existing_apps() {
    local existing=()
    for name in web api bot; do
        if [ -d "apps/$name" ]; then
            existing+=("$name")
        fi
    done
    echo "${existing[@]}"
}

# Fonction pour d√©tecter quels workspaces ont √©t√© modifi√©s (et existent)
detect_changed_workspaces() {
    local staged_files=$(get_staged_files)
    local potential=()

    # V√©rifier apps/web
    if echo "$staged_files" | grep -q "^apps/web/"; then
        potential+=("web")
    fi

    # V√©rifier apps/api
    if echo "$staged_files" | grep -q "^apps/api/"; then
        potential+=("api")
    fi

    # V√©rifier apps/bot
    if echo "$staged_files" | grep -q "^apps/bot/"; then
        potential+=("bot")
    fi

    # V√©rifier packages partag√©s (affectent potentiellement toutes les apps)
    if echo "$staged_files" | grep -q "^packages/"; then
        potential=("web" "api" "bot")
    fi

    # V√©rifier fichiers de configuration racine
    if echo "$staged_files" | grep -E '^(turbo\.json|pnpm-workspace\.yaml|tsconfig\.json|biome\.json)' > /dev/null; then
        potential=("web" "api" "bot")
    fi

    # Filtrer pour ne garder que les apps existantes (√©vite de lancer des checks sur des workspaces supprim√©s)
    local existing_apps=()
    local declared
    declared=($(get_existing_apps))
    if [ "${#potential[@]}" -eq 0 ]; then
        echo "${existing_apps[@]}"
        return
    fi

    for p in "${potential[@]}"; do
        for e in "${declared[@]}"; do
            if [ "$p" = "$e" ]; then
                # √©viter doublons
                if ! printf '%s\n' "${existing_apps[@]}" | grep -Fxq "$p"; then
                    existing_apps+=("$p")
                fi
            fi
        done
    done

    echo "${existing_apps[@]}"
}

# V√©rifier si seulement des fichiers non-critiques
if check_only_non_critical_files; then
    echo "‚ÑπÔ∏è  Seuls des fichiers non-critiques modifi√©s. Pre-commit ignor√©."
    echo "‚úÖ Pre-commit valid√© !"
    exit 0
fi

# V√©rifier si des fichiers de code ont √©t√© modifi√©s
if ! check_source_files_changed; then
    echo "‚ÑπÔ∏è  Aucun fichier de code modifi√©. Pre-commit ignor√©."
    echo "‚úÖ Pre-commit valid√© !"
    exit 0
fi

# Lancer lint-staged (formatage et linting automatique avec Biome)
echo "üé® Formatage et linting automatique avec Biome..."
pnpm exec lint-staged

if [ $? -ne 0 ]; then
    echo "‚ùå Biome check √©chou√©. Commit annul√©."
    echo "üí° Astuce: Ex√©cutez 'pnpm biome check --write .' pour corriger automatiquement."
    exit 1
fi

# D√©tecter les workspaces modifi√©s pour la v√©rification des types
workspaces=($(detect_changed_workspaces))

# Si aucun workspace affect√©, sortir
if [ ${#workspaces[@]} -eq 0 ]; then
    echo "‚úÖ Pre-commit valid√© !"
    exit 0
fi

echo "üìÅ Workspaces modifi√©s: ${workspaces[*]}"

# V√©rification des types TypeScript
typecheck_command="pnpm typecheck --filter="

for i in "${!workspaces[@]}"; do
    if [ "$i" -eq 0 ]; then
        typecheck_command+="${workspaces[$i]}"
    else
        typecheck_command+=" --filter=${workspaces[$i]}"
    fi
done

echo "üìù V√©rification des types TypeScript..."
echo "  üíª Commande: $typecheck_command"

eval "$typecheck_command"

if [ $? -ne 0 ]; then
    echo "‚ùå Erreurs TypeScript d√©tect√©es. Commit annul√©."
    echo "üí° Astuce: Ex√©cutez 'pnpm type-check' pour voir tous les probl√®mes."
    exit 1
fi

echo "‚úÖ Pre-commit valid√© pour les workspaces: ${workspaces[*]}"
echo "üéâ Tous les checks sont pass√©s, commit autoris√© !"
