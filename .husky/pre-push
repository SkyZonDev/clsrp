#!/bin/bash
# .husky/pre-push

echo "üöÄ V√©rification pre-push du monorepo CLSRP..."

# Fonction pour r√©cup√©rer les fichiers modifi√©s
get_changed_files() {
    git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only --cached
}

# Fonction pour v√©rifier si des fichiers de code ont √©t√© modifi√©s
check_source_files_changed() {
    local changed_files=$(get_changed_files)
    echo "$changed_files" | grep -E '\.(ts|tsx|js|jsx|json|css|scss|sass|md|sql)$' > /dev/null
    return $?
}

# Fonction pour d√©tecter quels workspaces ont √©t√© modifi√©s
detect_changed_workspaces() {
    local changed_files=$(get_changed_files)
    local workspaces=()

    if echo "$changed_files" | grep -q "^apps/web/"; then
        workspaces+=("web")
    fi

    if echo "$changed_files" | grep -q "^apps/api/"; then
        workspaces+=("api")
    fi

    if echo "$changed_files" | grep -q "^apps/bot/"; then
        workspaces+=("bot")
    fi

    if echo "$changed_files" | grep -q "^packages/"; then
        workspaces=("web" "api" "bot")
    fi

    if echo "$changed_files" | grep -E '^(turbo\.json|pnpm-workspace\.yaml|tsconfig\.json|biome\.json)' > /dev/null; then
        workspaces=("web" "api" "bot")
    fi

    echo "${workspaces[@]}"
}

# Fonction pour v√©rifier si seulement des fichiers non-critiques ont √©t√© modifi√©s
check_only_docs_or_config() {
    local changed_files=$(get_changed_files)

    local total_files=$(echo "$changed_files" | wc -l)
    local non_critical=$(echo "$changed_files" | grep -E '^(README\.md|LICENSE|\.gitignore|\.husky/)' | wc -l)

    if [ "$total_files" -eq "$non_critical" ] && [ "$total_files" -gt 0 ]; then
        return 0
    fi
    return 1
}

# Fonction pour nettoyer les builds
clean_builds() {
    echo "üßπ Nettoyage des dossiers de build..."

    local dirs_to_clean=(
        "apps/web/.next"
        "apps/web/dist"
        "apps/api/dist"
        "apps/bot/dist"
        "packages/ui/dist"
        ".turbo"
    )

    for dir in "${dirs_to_clean[@]}"; do
        if [ -d "$dir" ]; then
            echo "  üóëÔ∏è  Suppression de $dir"
            rm -rf "$dir"
        fi
    done
}

# V√©rifier si seulement des fichiers non-critiques ont √©t√© modifi√©s
if check_only_docs_or_config; then
    echo "‚ÑπÔ∏è  Seuls des fichiers non-critiques (README, etc.) modifi√©s. Build ignor√©e."
    echo "‚úÖ Pre-push valid√© !"
    exit 0
fi

# V√©rifier si des fichiers de code ont √©t√© modifi√©s
if ! check_source_files_changed; then
    echo "‚ÑπÔ∏è  Aucun fichier de code modifi√©. Build ignor√©e."
    echo "‚úÖ Pre-push valid√© !"
    exit 0
fi

# D√©tecter les workspaces modifi√©s
workspaces=($(detect_changed_workspaces))

if [ ${#workspaces[@]} -eq 0 ]; then
    echo "‚ÑπÔ∏è  Aucun workspace affect√©. Build ignor√©e."
    echo "‚úÖ Pre-push valid√© !"
    exit 0
fi

echo "üìÅ Workspaces modifi√©s d√©tect√©s: ${workspaces[*]}"

# Lancer Biome check sur tout le projet
echo "üîç V√©rification du code avec Biome..."
pnpm biome check .

if [ $? -ne 0 ]; then
    echo "‚ùå Biome check √©chou√©. Push annul√©."
    echo "üí° Astuce: Ex√©cutez 'pnpm biome check --write .' pour corriger automatiquement."
    exit 1
fi

# Lancer la v√©rification des types
echo "üìù V√©rification des types TypeScript..."
pnpm typecheck

if [ $? -ne 0 ]; then
    echo "‚ùå V√©rification des types √©chou√©e. Push annul√©."
    exit 1
fi

# Builder uniquement les workspaces modifi√©s
echo "üèóÔ∏è  Build des applications modifi√©es..."

build_command="pnpm build --filter="

for i in "${!workspaces[@]}"; do
    if [ $i -eq 0 ]; then
        build_command+="${workspaces[$i]}"
    else
        build_command+=" --filter=${workspaces[$i]}"
    fi
done

echo "  üíª Commande: $build_command"

eval $build_command

if [ $? -ne 0 ]; then
    clean_builds
    echo "‚ùå Build √©chou√©e. Push annul√©."
    exit 1
fi

clean_builds

echo "‚úÖ Pre-push valid√© pour les workspaces: ${workspaces[*]}"
echo "üéâ Tous les checks sont pass√©s, push autoris√© !"
